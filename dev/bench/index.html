<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OCCT-RT Benchmarks</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background: #f5f5f5;
      color: #333;
      max-width: 1400px;
      margin: 0 auto;
    }
    h1 { margin: 0 0 5px 0; font-size: 28px; }
    h2 { margin: 30px 0 15px 0; font-size: 20px; color: #444; }
    .subtitle {
      color: #666;
      margin-bottom: 25px;
      font-size: 14px;
    }
    .subtitle a { color: #0066cc; text-decoration: none; }
    .subtitle a:hover { text-decoration: underline; }

    /* Geometry Gallery */
    .gallery {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }
    .gallery-item {
      background: white;
      border-radius: 8px;
      padding: 10px;
      text-align: center;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .gallery-item img {
      width: 100%;
      height: auto;
      border-radius: 4px;
      background: #f0f0f0;
    }
    .gallery-item .name {
      margin-top: 8px;
      font-size: 13px;
      font-weight: 500;
      color: #333;
    }
    .gallery-item .placeholder {
      width: 100%;
      aspect-ratio: 1;
      background: linear-gradient(135deg, #e0e0e0 25%, #f0f0f0 50%, #e0e0e0 75%);
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #999;
      font-size: 12px;
    }

    /* Performance Table */
    .table-container {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 30px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      overflow-x: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }
    th, td {
      padding: 10px 12px;
      text-align: right;
      border-bottom: 1px solid #eee;
    }
    th {
      font-weight: 600;
      color: #555;
      background: #fafafa;
    }
    th:first-child, td:first-child {
      text-align: left;
      font-weight: 500;
    }
    tr:hover td { background: #f8f8f8; }
    .value { font-family: "SF Mono", Monaco, monospace; }
    .na { color: #ccc; }

    /* Charts */
    .chart-section {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .chart-title {
      font-size: 16px;
      font-weight: 600;
      margin: 0 0 15px 0;
      color: #333;
    }
    .chart-container {
      position: relative;
      height: 250px;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }
  </style>
</head>
<body>
  <h1>OCCT-RT Benchmark Results</h1>
  <p class="subtitle">
    Performance tracking for <a href="https://github.com/PozzettiAndrea/OCCT-RT">OCCT-RT</a> raytracer
  </p>

  <h2>Geometry Gallery</h2>
  <div id="gallery" class="gallery">
    <div class="loading">Loading renders...</div>
  </div>

  <h2>Performance Summary (M rays/sec)</h2>
  <div class="table-container">
    <table id="perf-table">
      <thead>
        <tr>
          <th>Platform</th>
          <th>OCCT</th>
          <th>Embree</th>
          <th>SIMD4</th>
          <th>SIMD8</th>
        </tr>
      </thead>
      <tbody id="perf-tbody">
        <tr><td colspan="5" class="loading">Loading data...</td></tr>
      </tbody>
    </table>
  </div>

  <h2>Performance by Geometry</h2>
  <div id="charts"></div>

  <script>
    // Platform configurations
    const platforms = [
      { id: 'linux-x64-occt', os: 'Linux x64', backend: 'occt' },
      { id: 'linux-x64-embree', os: 'Linux x64', backend: 'embree' },
      { id: 'linux-x64-simd4', os: 'Linux x64', backend: 'simd4' },
      { id: 'linux-x64-simd8', os: 'Linux x64', backend: 'simd8' },
      { id: 'macos-arm64-occt', os: 'macOS ARM64', backend: 'occt' },
      { id: 'win-x64-occt', os: 'Windows x64', backend: 'occt' }
    ];

    const backendOrder = ['occt', 'embree', 'simd4', 'simd8'];
    const osOrder = ['Linux x64', 'macOS ARM64', 'Windows x64'];

    const colors = {
      'linux-x64-occt': '#2196F3',
      'linux-x64-embree': '#4CAF50',
      'linux-x64-simd4': '#FF9800',
      'linux-x64-simd8': '#F44336',
      'macos-arm64-occt': '#9C27B0',
      'win-x64-occt': '#00BCD4'
    };

    // Known geometries for gallery
    const geometries = ['box', 'sphere', 'torus', 'cone', 'cylinder', 'bspline_surface'];

    async function loadData(platformId) {
      try {
        const response = await fetch(`${platformId}/data.js`);
        const text = await response.text();
        const match = text.match(/window\.BENCHMARK_DATA\s*=\s*(\{[\s\S]*\});?/);
        if (match) {
          return JSON.parse(match[1]);
        }
      } catch (e) {
        console.log(`No data for ${platformId}`);
      }
      return null;
    }

    function getLatestBenchmarks(data) {
      const entries = data?.entries?.Benchmark || [];
      if (entries.length === 0) return {};
      const latest = entries[entries.length - 1];
      const result = {};
      for (const bench of latest.benches || []) {
        result[bench.name] = bench.value / 1000000; // Convert to millions
      }
      return result;
    }

    function renderGallery() {
      const gallery = document.getElementById('gallery');
      gallery.innerHTML = '';

      for (const geom of geometries) {
        const item = document.createElement('div');
        item.className = 'gallery-item';

        const imgUrl = `../renders/${geom}.png`;
        item.innerHTML = `
          <img src="${imgUrl}" alt="${geom}" onerror="this.outerHTML='<div class=\\'placeholder\\'>No render</div>'" />
          <div class="name">${geom.replace('_', ' ')}</div>
        `;

        gallery.appendChild(item);
      }
    }

    function renderTable(allData) {
      const tbody = document.getElementById('perf-tbody');
      tbody.innerHTML = '';

      // Group by OS
      for (const os of osOrder) {
        const row = document.createElement('tr');

        // Platform name
        const nameCell = document.createElement('td');
        nameCell.textContent = os;
        row.appendChild(nameCell);

        // Backend columns
        for (const backend of backendOrder) {
          const cell = document.createElement('td');
          const platformId = platforms.find(p => p.os === os && p.backend === backend)?.id;

          if (platformId && allData[platformId]) {
            const benches = getLatestBenchmarks(allData[platformId]);
            // Average across all geometries
            const values = Object.values(benches);
            if (values.length > 0) {
              const avg = values.reduce((a, b) => a + b, 0) / values.length;
              cell.innerHTML = `<span class="value">${avg.toFixed(1)}</span>`;
            } else {
              cell.innerHTML = '<span class="na">-</span>';
            }
          } else {
            cell.innerHTML = '<span class="na">-</span>';
          }

          row.appendChild(cell);
        }

        tbody.appendChild(row);
      }
    }

    function renderCharts(allData) {
      const chartsDiv = document.getElementById('charts');
      chartsDiv.innerHTML = '';

      // Collect all geometry names
      const allGeometries = new Set();
      for (const data of Object.values(allData)) {
        const entries = data?.entries?.Benchmark || [];
        for (const entry of entries) {
          for (const bench of entry.benches || []) {
            allGeometries.add(bench.name);
          }
        }
      }

      // Create one chart per geometry
      for (const geomName of [...allGeometries].sort()) {
        const section = document.createElement('div');
        section.className = 'chart-section';

        const title = document.createElement('h3');
        title.className = 'chart-title';
        title.textContent = geomName.replace('_', ' ');
        section.appendChild(title);

        const container = document.createElement('div');
        container.className = 'chart-container';
        const canvas = document.createElement('canvas');
        container.appendChild(canvas);
        section.appendChild(container);

        chartsDiv.appendChild(section);

        // Build datasets for this geometry
        const datasets = [];
        let maxCommits = 0;

        for (const platform of platforms) {
          const data = allData[platform.id];
          if (!data) continue;

          const entries = data.entries?.Benchmark || [];
          if (entries.length === 0) continue;

          maxCommits = Math.max(maxCommits, entries.length);

          const values = entries.map(entry => {
            const bench = entry.benches?.find(b => b.name === geomName);
            return bench ? bench.value / 1000000 : null;
          });

          datasets.push({
            label: `${platform.os} (${platform.backend.toUpperCase()})`,
            data: values,
            borderColor: colors[platform.id] || '#999',
            backgroundColor: colors[platform.id] || '#999',
            tension: 0.1,
            pointRadius: 2
          });
        }

        // Generate commit labels from first dataset with data
        let labels = [];
        for (const platform of platforms) {
          const data = allData[platform.id];
          if (data?.entries?.Benchmark?.length > 0) {
            labels = data.entries.Benchmark.map(e => e.commit?.id?.substring(0, 7) || '?');
            break;
          }
        }

        new Chart(canvas, {
          type: 'line',
          data: { labels, datasets },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { intersect: false, mode: 'index' },
            plugins: {
              legend: { position: 'bottom', labels: { boxWidth: 12, font: { size: 11 } } },
              tooltip: {
                callbacks: {
                  label: ctx => `${ctx.dataset.label}: ${ctx.parsed.y?.toFixed(1) || '-'}M rays/sec`
                }
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                title: { display: true, text: 'M rays/sec' },
                ticks: { callback: v => v.toFixed(1) }
              },
              x: { title: { display: true, text: 'Commit' } }
            }
          }
        });
      }
    }

    async function init() {
      // Render gallery immediately
      renderGallery();

      // Load all platform data
      const allData = {};
      for (const platform of platforms) {
        const data = await loadData(platform.id);
        if (data) {
          allData[platform.id] = data;
        }
      }

      // Render table and charts
      renderTable(allData);
      renderCharts(allData);
    }

    init();
  </script>
</body>
</html>
