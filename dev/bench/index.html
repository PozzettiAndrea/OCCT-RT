<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OCCT-RT Benchmarks</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background: #f5f5f5;
      color: #333;
    }
    h1 {
      margin: 0 0 10px 0;
      font-size: 24px;
    }
    .subtitle {
      color: #666;
      margin-bottom: 20px;
    }
    .subtitle a {
      color: #0066cc;
      text-decoration: none;
    }
    .subtitle a:hover {
      text-decoration: underline;
    }
    .platform-section {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .platform-title {
      font-size: 18px;
      font-weight: 600;
      margin: 0 0 15px 0;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
    }
    .chart-container {
      position: relative;
      height: 300px;
    }
    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }
  </style>
</head>
<body>
  <h1>OCCT-RT Benchmark Results</h1>
  <p class="subtitle">
    Performance tracking for <a href="https://github.com/PozzettiAndrea/OCCT-RT">OCCT-RT</a> raytracer
  </p>

  <div id="content">
    <div class="loading">Loading benchmark data...</div>
  </div>

  <script>
    const platforms = [
      { id: 'linux-x64-occt', name: 'Linux x64 (OCCT BVH)' },
      { id: 'linux-x64-embree', name: 'Linux x64 (Embree)' },
      { id: 'macos-arm64-occt', name: 'macOS ARM64 (OCCT BVH)' }
    ];

    const colors = {
      box: '#4CAF50',
      bspline_surface: '#2196F3',
      cone: '#FF9800',
      cylinder: '#9C27B0',
      sphere: '#F44336',
      torus: '#00BCD4'
    };

    async function loadData(platform) {
      try {
        const response = await fetch(`${platform}/data.js`);
        const text = await response.text();
        const match = text.match(/window\.BENCHMARK_DATA\s*=\s*(\{[\s\S]*\});?/);
        if (match) {
          return JSON.parse(match[1]);
        }
      } catch (e) {
        console.error(`Failed to load ${platform}:`, e);
      }
      return null;
    }

    function createChart(container, data, platformName) {
      const entries = data.entries.Benchmark || [];
      if (entries.length === 0) return;

      const benchNames = [...new Set(entries.flatMap(e => e.benches.map(b => b.name)))];

      const datasets = benchNames.map(name => {
        const values = entries.map(entry => {
          const bench = entry.benches.find(b => b.name === name);
          return bench ? bench.value / 1000000 : null; // Convert to millions
        });
        return {
          label: name,
          data: values,
          borderColor: colors[name] || '#999',
          backgroundColor: colors[name] || '#999',
          tension: 0.1,
          pointRadius: 3
        };
      });

      const labels = entries.map(e => e.commit.id.substring(0, 7));

      new Chart(container, {
        type: 'line',
        data: { labels, datasets },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            intersect: false,
            mode: 'index'
          },
          plugins: {
            legend: {
              position: 'bottom'
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return `${context.dataset.label}: ${context.parsed.y.toFixed(1)}M rays/sec`;
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'M rays/sec'
              },
              ticks: {
                callback: function(value) {
                  return value.toFixed(1);
                }
              }
            },
            x: {
              title: {
                display: true,
                text: 'Commit'
              }
            }
          }
        }
      });
    }

    async function init() {
      const content = document.getElementById('content');
      content.innerHTML = '';

      for (const platform of platforms) {
        const data = await loadData(platform.id);
        if (!data) continue;

        const section = document.createElement('div');
        section.className = 'platform-section';

        const title = document.createElement('h2');
        title.className = 'platform-title';
        title.textContent = platform.name;
        section.appendChild(title);

        const chartContainer = document.createElement('div');
        chartContainer.className = 'chart-container';
        const canvas = document.createElement('canvas');
        chartContainer.appendChild(canvas);
        section.appendChild(chartContainer);

        content.appendChild(section);
        createChart(canvas, data, platform.name);
      }

      if (content.children.length === 0) {
        content.innerHTML = '<div class="loading">No benchmark data available yet.</div>';
      }
    }

    init();
  </script>
</body>
</html>
